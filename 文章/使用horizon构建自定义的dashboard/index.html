<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
    <title>西斯小跳的博客  | 使用Horizon构建自定义的Dashboard</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.40.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="使用Horizon构建自定义的Dashboard" />
<meta property="og:description" content="本章主要讲解如何使用Horizon创建一个你自己的Dashboard
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heisenberg2017.github.io/%E6%96%87%E7%AB%A0/%E4%BD%BF%E7%94%A8horizon%E6%9E%84%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84dashboard/" />



<meta property="article:published_time" content="2019-09-22T15:55:49&#43;08:00"/>

<meta property="article:modified_time" content="2019-09-22T15:55:49&#43;08:00"/>











<meta itemprop="name" content="使用Horizon构建自定义的Dashboard">
<meta itemprop="description" content="本章主要讲解如何使用Horizon创建一个你自己的Dashboard
">


<meta itemprop="datePublished" content="2019-09-22T15:55:49&#43;08:00" />
<meta itemprop="dateModified" content="2019-09-22T15:55:49&#43;08:00" />
<meta itemprop="wordCount" content="0">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用Horizon构建自定义的Dashboard"/>
<meta name="twitter:description" content="本章主要讲解如何使用Horizon创建一个你自己的Dashboard
"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://heisenberg2017.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      西斯小跳的博客
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/%E6%95%99%E7%A8%8B/" title="教程 page">
              教程
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/%E6%96%87%E7%AB%A0/" title="文章 page">
              文章
            </a>
          </li>
          
        </ul>
      
      







<a href="https://github.com/Heisenberg2017" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        文章
      </p>
      <h1 class="f1 athelas mb1">使用Horizon构建自定义的Dashboard</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-09-22T15:55:49&#43;08:00">September 22, 2019</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>本章主要讲解如何使用Horizon创建一个你自己的Dashboard
</p>

<h4 id="快速构建">快速构建</h4>

<p>这里可以用官方提供的构建工具去快速创建好一个模板，如果本地没有下载和配置tox也没关系，直接按照本文章
后面贴出的代码及文件名对应文件树的位置进行创建。</p>

<pre><code>$ mkdir openstack_dashboard/dashboards/mydashboard

$ tox -e manage -- startdash mydashboard \
  --target openstack_dashboard/dashboards/mydashboard

$ mkdir openstack_dashboard/dashboards/mydashboard/mypanel

$ tox -e manage -- startpanel mypanel \
  --dashboard=openstack_dashboard.dashboards.mydashboard \
  --target=openstack_dashboard/dashboards/mydashboard/mypanel
</code></pre>

<h4 id="构建完成文件树结构">构建完成文件树结构</h4>

<pre><code>mydashboard
├── dashboard.py
├── __init__.py
├── mypanel
│   ├── __init__.py
│   ├── panel.py
│   ├── templates
│   │   └── mypanel
│   │       └── index.html
│   ├── tests.py
│   ├── urls.py
│   └── views.py
├── static
│   └── mydashboard
│       ├── css
│       │   └── mydashboard.css
│       └── js
│           └── mydashboard.js
└── templates
    └── mydashboard
        └── base.html
</code></pre>

<h4 id="创建dashboard">创建Dashboard</h4>

<p>打开或者创建一个包含以下内容的dashboard.py文件</p>

<pre><code class="language-python">from django.utils.translation import ugettext_lazy as _

import horizon


class Mydashboard(horizon.Dashboard):
    name = _(&quot;Mydashboard&quot;)
    slug = &quot;mydashboard&quot;
    panels = ()           # Add your panels here.
    default_panel = ''    # Specify the slug of the dashboard's default panel.


horizon.register(Mydashboard)
</code></pre>

<p>该文件中name声明了Dashboard的名称，内部组件互相引用使用的是slug的名称,你可以
在这里添加panels，和设置默认的panel。</p>

<p>注： 新版本中Panel和PanelGroup统一通过plugin的方式进行注册，相关配置文件在openstack_dashboard/enabled下，
Dashboard仅专注与panel相关功能的实现.</p>

<h4 id="创建panel">创建Panel</h4>

<p>mypanel的文件树</p>

<pre><code>mypanel
 ├── __init__.py
 ├── models.py
 ├── panel.py
 ├── templates
 │   └── mypanel
 │     └── index.html
 ├── tests.py
 ├── urls.py
 └── views.py
</code></pre>

<p>打开或者创建一个包含以下内容的panel.py文件</p>

<pre><code class="language-python">from django.utils.translation import ugettext_lazy as _

import horizon

from openstack_dashboard.dashboards.mydashboard import dashboard


class Mypanel(horizon.Panel):
    name = _(&quot;Mypanel&quot;)
    slug = &quot;mypanel&quot;


dashboard.Mydashboard.register(Mypanel)
</code></pre>

<p>打开dashboard.py把下面代码插入到Mydashboard class的上方</p>

<pre><code class="language-python">class Mygroup(horizon.PanelGroup):
    slug = &quot;mygroup&quot;
    name = _(&quot;My Group&quot;)
    panels = ('mypanel',)
</code></pre>

<p>修改Mydashboard类去包含我们添加的Mygroup</p>

<pre><code class="language-python">class Mydashboard(horizon.Dashboard):
   name = _(&quot;My Dashboard&quot;)
   slug = &quot;mydashboard&quot;
   panels = (Mygroup,)  # Add your panels here.
   default_panel = 'mypanel'  # Specify the slug of the default panel.
</code></pre>

<p>修改完成后的dashboard.py 如下所示</p>

<pre><code class="language-python">from django.utils.translation import ugettext_lazy as _

import horizon


class Mygroup(horizon.PanelGroup):
    slug = &quot;mygroup&quot;
    name = _(&quot;My Group&quot;)
    panels = ('mypanel',)


class Mydashboard(horizon.Dashboard):
    name = _(&quot;My Dashboard&quot;)
    slug = &quot;mydashboard&quot;
    panels = (Mygroup,)  # Add your panels here.
    default_panel = 'mypanel'  # Specify the slug of the default panel.


horizon.register(Mydashboard)
</code></pre>

<h4 id="表-选项卡-构建视图">表、选项卡、构建视图</h4>

<p>Horizon提供DataTable类用于处理表相关功能的抽象类，
我们只需要填写几个属性就可以使用复用DataTable所提供的功能</p>

<p>创建一个tables.py在mypanel目录下并添加如下代码</p>

<pre><code class="language-python">from django.utils.translation import ugettext_lazy as _

from horizon import tables


class InstancesTable(tables.DataTable):
    name = tables.Column(&quot;name&quot;, verbose_name=_(&quot;Name&quot;))
    status = tables.Column(&quot;status&quot;, verbose_name=_(&quot;Status&quot;))
    zone = tables.Column('availability_zone',
                          verbose_name=_(&quot;Availability Zone&quot;))
    image_name = tables.Column('image_name', verbose_name=_(&quot;Image Name&quot;))

    class Meta(object):
        name = &quot;instances&quot;
        verbose_name = _(&quot;Instances&quot;)
</code></pre>

<p>我们创建了一个DataTable的字类，这里声明了几个属性
tables.Column的第一个参数用来访问实例对象，
verbose_name在展示的时候用到，你可以自行修改然后重启
horizon服务查看页面渲染的结果，Meta里面的instances对应数据
表的名称。</p>

<p>我们这里为table添加一个过滤的动作，首先我们需要声明一个动作</p>

<pre><code class="language-python">class MyFilterAction(tables.FilterAction):
    name = &quot;myfilter&quot;
</code></pre>

<p>把MyFilterAction添加到InstancesTable中</p>

<pre><code class="language-python">class InstancesTable:
    class Meta(object):
        table_actions = (MyFilterAction,)
</code></pre>

<p>完整的tables.py文件如下所示</p>

<pre><code class="language-python">from django.utils.translation import ugettext_lazy as _

from horizon import tables


class MyFilterAction(tables.FilterAction):
    name = &quot;myfilter&quot;


class InstancesTable(tables.DataTable):
    name = tables.Column('name', \
                         verbose_name=_(&quot;Name&quot;))
    status = tables.Column('status', \
                           verbose_name=_(&quot;Status&quot;))
    zone = tables.Column('availability_zone', \
                         verbose_name=_(&quot;Availability Zone&quot;))
    image_name = tables.Column('image_name', \
                               verbose_name=_(&quot;Image Name&quot;))

    class Meta(object):
        name = &quot;instances&quot;
        verbose_name = _(&quot;Instances&quot;)
        table_actions = (MyFilterAction,)
</code></pre>

<h4 id="定义选项卡">定义选项卡</h4>

<p>创建tabs.py文件,完整代码如下</p>

<pre><code class="language-python">from django.utils.translation import ugettext_lazy as _

from horizon import exceptions
from horizon import tabs

from openstack_dashboard import api
from openstack_dashboard.dashboards.mydashboard.mypanel import tables


class InstanceTab(tabs.TableTab):
    name = _(&quot;Instances Tab&quot;)
    slug = &quot;instances_tab&quot;
    table_classes = (tables.InstancesTable,)
    template_name = (&quot;horizon/common/_detail_table.html&quot;)
    preload = False

    def has_more_data(self, table):
        return self._has_more

    def get_instances_data(self):
        try:
            marker = self.request.GET.get(
                        tables.InstancesTable._meta.pagination_param, None)

            instances, self._has_more = api.nova.server_list(
                self.request,
                search_opts={'marker': marker, 'paginate': True})

            return instances
        except Exception:
            self._has_more = False
            error_message = _('Unable to get instances')
            exceptions.handle(self.request, error_message)

            return []

class MypanelTabs(tabs.TabGroup):
    slug = &quot;mypanel_tabs&quot;
    tabs = (InstanceTab,)
    sticky = True
</code></pre>

<p>preload=False代表只有在点击的时候才会以AJAX方式加载数据，这种方式可以减少不必要的调用，
api.nova.server_list会调用novaclient发送http请求到nova，然后查询数据库，最后返回结果。</p>

<h4 id="创建视图函数">创建视图函数</h4>

<p>tabs.TabbedTableView类可以更好的配合table和tabs做页面渲染及展示，更多tabs.TabbedTableView相关的
可以在文末找到资料</p>

<pre><code class="language-python">from horizon import tabs

from openstack_dashboard.dashboards.mydashboard.mypanel \
    import tabs as mydashboard_tabs


class IndexView(tabs.TabbedTableView):
    tab_group_class = mydashboard_tabs.MypanelTabs
    template_name = 'mydashboard/mypanel/index.html'

    def get_data(self, request, context, *args, **kwargs):
        # Add data to the context here...
        return context
</code></pre>

<h3 id="其他文件">其他文件</h3>

<p>url.py</p>

<pre><code class="language-python">from openstack_dashboard.dashboards.mydashboard.mypanel import views


urlpatterns = [
    url(r'^$', views.IndexView.as_view(), name='index'),
]
</code></pre>

<p>index.html</p>

<pre><code>{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans &quot;My Panel&quot; %}{% endblock %}

{% block page_header %}
   {% include &quot;horizon/common/_page_header.html&quot; with title=_(&quot;My Panel&quot;) %}
{% endblock page_header %}

{% block main %}
&lt;div class=&quot;row&quot;&gt;
   &lt;div class=&quot;col-sm-12&quot;&gt;
   {{ tab_group.render }}
   &lt;/div&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>

<p>TODO: 这里还有几个文件没有写进来</p>

<h4 id="使代码生效">使代码生效</h4>

<p>为了使上面所添加的配置生效你需要在 openstack_dashboard/enabled创建一个_50_mydashboard.py文件</p>

<pre><code class="language-python"># The name of the dashboard to be added to HORIZON['dashboards']. Required.
DASHBOARD = 'mydashboard'

# If set to True, this dashboard will not be added to the settings.
DISABLED = False

# A list of applications to be added to INSTALLED_APPS.
ADD_INSTALLED_APPS = [
    'openstack_dashboard.dashboards.mydashboard',
]
</code></pre>

<p>重启服务,然后用浏览器打开dashboard就看mydashboard了。</p>

<h4 id="参考文章及推荐阅读">参考文章及推荐阅读</h4>

<ul>
<li><p>本文章基于
<a href="https://docs.openstack.org/horizon/rocky/contributor/tutorials/dashboard.html">Building a Dashboard using Horizon</a>，
如果想为table添加更加复杂的行为可以查看
<a href="https://docs.openstack.org/horizon/rocky/contributor/tutorials/table_actions.html">Adding a complex action to a table</a></p></li>

<li><p>《OpenStack设计与实现》第11章对Horizon进行了比较全面的讲解</p></li>
</ul><ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://heisenberg2017.github.io/" >
    &copy; 2019 西斯小跳的博客
  </a>
    <div>







<a href="https://github.com/Heisenberg2017" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
